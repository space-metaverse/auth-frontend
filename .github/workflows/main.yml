name: Deploy Auth Frontend
on:
  push:
    branches: [ dev ]
jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout auth-frontend
        uses: actions/checkout@v3
        with:
          path: '.'

      - name: Checkout Terraform
        uses: actions/checkout@v3
        with:
          repository: 'space-metaverse/terraform'
          token: ${{ secrets.GH_ACCESS_TOKEN }}
          path: 'terraform'
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.3.2

      - name: Test setup
        run: ls -la && cd terraform && ls -la

      - name: Terraform Init
        run: |
          ./terraform/build_image.sh
          ./terraform/deploy_infra.sh
        env:
          CI_COMMIT_REF_NAME: ${{ github.ref_name }}
          APP_NAME: ${{ secrets.APP_NAME }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}_${{ github.ref_name }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}_${{ github.ref_name }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
          SERVICE_NAME: ${{ secrets.SERVICE_NAME }}
          AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
          PATH_PATTERN: ${{ secrets.PATH_PATTERN }}
          CONTAINER_PORT: ${{ secrets.CONTAINER_PORT }}
          VPC_ID: ${{ secrets.VPC_ID }}_${{ github.ref_name }}
          SUBNET_IDS: ${{ secrets.SUBNET_IDS }}_${{ github.ref_name }}
          LISTNER_ARN: ${{ secrets.LISTNER_ARN }}_${{ github.ref_name }}
          CLUSTER_NAME: ${{ secrets.CLUSTER_NAME }}_${{ github.ref_name }}
